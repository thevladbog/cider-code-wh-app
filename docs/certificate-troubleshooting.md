# Устранение проблем с сертификатами

## Общие проблемы и решения

### Ошибка "Загруженный сертификат недействителен"

Эта ошибка может возникать по нескольким причинам:

1. **Неверный формат файла сертификата или ключа**
   - Сертификат должен быть в формате PEM и содержать маркеры `-----BEGIN CERTIFICATE-----` и `-----END CERTIFICATE-----`
   - Приватный ключ должен содержать маркеры `-----BEGIN PRIVATE KEY-----` или `-----BEGIN RSA PRIVATE KEY-----`

2. **Истекший срок действия сертификата**
   - Проверьте даты действия сертификата с помощью команды:
     ```bash
     openssl x509 -in cert.pem -noout -dates
     ```

3. **Сертификат еще не действителен**
   - Иногда дата начала действия сертификата может быть в будущем
   - Проверьте параметр `notBefore` в выводе команды выше

4. **Отсутствует информация о домене (CN)**
   - В сертификате должно присутствовать поле Common Name (CN) с доменным именем
   - Некоторые современные сертификаты вместо CN используют расширение Subject Alternative Name (SAN)
   - Для детального анализа проблемы используйте инструмент анализа сертификатов:
     ```bash
     node scripts/analyze-certificate.cjs path/to/cert.pem
     ```

5. **Несоответствие сертификата и приватного ключа**
   - Проверьте, что сертификат и приватный ключ соответствуют друг другу:
     ```bash
     openssl x509 -noout -modulus -in cert.pem | openssl md5
     openssl rsa -noout -modulus -in key.pem | openssl md5
     ```
   - Оба вывода должны совпадать

6. **Проблемы с форматом CA-сертификата**
   - Если вы загружаете CA-сертификат, убедитесь, что он также в правильном формате PEM
   - CA-сертификат является опциональным, но если он предоставлен, то должен быть действительным

7. **Несовместимый алгоритм ключа**
   - Приложение ожидает сертификаты, использующие алгоритм RSA
   - Если вы видите ошибку: `Cannot read public key. OID is not RSA` или `Error validating certificate`, это может означать, что ваш сертификат использует несовместимый алгоритм ключа (например, ECDSA/ECC или DSA)
   - Для проверки алгоритма ключа используйте команду:
     ```bash
     openssl x509 -in cert.pem -noout -pubkey | openssl pkey -pubin -inform PEM -text
     ```
   - Для решения проблемы сгенерируйте новый сертификат с RSA ключом:
     ```bash
     node scripts/generate-rsa-certs.cjs
     ```

8. **Системное время**
   - Убедитесь, что системное время корректное, так как проверка срока действия сертификата зависит от системного времени

## Рекомендации по подготовке сертификатов

1. **Использование корректных PEM файлов**
   - Убедитесь, что вы используете сертификаты в формате PEM (не DER или P7B/PKCS#7)
   - При необходимости конвертируйте формат:
     ```bash
     # Из DER в PEM
     openssl x509 -inform DER -in certificate.der -out certificate.pem
     
     # Из P7B в PEM
     openssl pkcs7 -print_certs -in certificate.p7b -out certificate.pem
     ```

2. **Проверка перед загрузкой**
   - Всегда проверяйте сертификаты локально перед загрузкой:
     ```bash
     # Проверка сертификата
     openssl x509 -in cert.pem -noout -text
     
     # Проверка ключа
     openssl rsa -in key.pem -check
     
     # Проверка соответствия сертификата и ключа
     openssl x509 -noout -modulus -in cert.pem | openssl md5
     openssl rsa -noout -modulus -in key.pem | openssl md5
     ```

3. **Пакетная конвертация сертификатов**
   - Используйте следующий скрипт для преобразования всех сертификатов и ключей из разных форматов в PEM:
     ```bash
     # Преобразование сертификата из CRT/CER/DER в PEM
     for file in *.crt *.cer *.der; do 
       if [ -f "$file" ]; then
         pem_file="${file%.*}.pem"
         openssl x509 -inform DER -in "$file" -out "$pem_file" 2>/dev/null || \
         openssl x509 -inform PEM -in "$file" -out "$pem_file"
       fi
     done
     ```

## Отладка проблем с сертификатами

Приложение теперь включает подробные логи для диагностики проблем с сертификатами. Вы можете посмотреть эти логи в консоли разработчика (F12) или в системных логах приложения.

Для проверки сертификата и приватного ключа используйте скрипт, включенный в приложение:
```bash
node scripts/verify-cert-key-pair.cjs path/to/cert.pem path/to/key.pem
```

## Контакты для поддержки

Если проблемы с сертификатами продолжаются, обратитесь в службу технической поддержки для получения помощи:
1. Опишите шаги, которые привели к ошибке
2. Предоставьте информацию о сертификатах (но не сами сертификаты)
3. Приложите логи приложения, если это возможно
