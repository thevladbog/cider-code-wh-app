# Защищенная система управления сертификатами

## Обзор

Данный документ описывает реализованную систему защищенного управления TLS сертификатами в нашем CI/CD pipeline. Система генерирует готовые к использованию в продакшен TLS сертификаты в процессе релиза, шифрует их с помощью пароля и безопасно распространяет пароль через Telegram.

## Как это работает

1. **Генерация сертификатов**: Во время сборки стабильного релиза TLS-сертификаты генерируются через Let's Encrypt с использованием DNS или HTTP challenge.

2. **Защита паролем**: Сгенерированные сертификаты шифруются в ZIP-архиве с использованием сильного случайного пароля.

3. **Безопасное распространение**: Пароль автоматически отправляется в указанный канал Telegram, доступ к которому имеют только авторизованные администраторы.

4. **Хранение артефактов**: Защищенный паролем архив сертификатов прикрепляется к релизу на GitHub в качестве артефакта.

## Функции безопасности

- **Сильное шифрование**: Сертификаты защищены с помощью шифрования AES-256
- **Генерация случайного пароля**: Каждый релиз использует уникальный, криптографически стойкий случайный пароль
- **Безопасная передача**: Пароль передается через Telegram Bot API по протоколу HTTPS
- **Ограниченный доступ**: Только авторизованные администраторы имеют доступ к каналу Telegram
- **Отсутствие хранения паролей**: Пароль не сохраняется в репозитории или среде CI

## Требования к настройке

Для использования этой системы необходимо настроить следующие секреты GitHub Actions:

1. **`TELEGRAM_BOT_TOKEN`**: API-токен вашего Telegram бота
   - Создайте бот с помощью [@BotFather](https://t.me/botfather) в Telegram
   - Скопируйте предоставленный API-токен

2. **`TELEGRAM_CHAT_ID`**: ID Telegram канала или группы для доставки пароля
   - Добавьте своего бота в целевой канал/группу
   - Получите ID чата с помощью Telegram API или [@userinfobot](https://t.me/userinfobot)

## Процесс релиза

1. Когда создается релиз в ветке `release-stable`, CI/CD pipeline:
   - Генерирует TLS сертификаты
   - Создает защищенный паролем архив
   - Отправляет пароль в канал Telegram
   - Прикрепляет защищенный архив к артефактам релиза

2. Авторизованные администраторы могут:
   - Получить пароль из канала Telegram
   - Скачать защищенный архив из релиза на GitHub
   - Извлечь сертификаты, используя предоставленный пароль
   - Развернуть их в продакшн-среде

## Использование защищенных сертификатов

### Linux/macOS

```bash
# Извлечение сертификатов (будет запрошен пароль)
unzip secure-certificates-v*.zip -d ./certs/

# Установка соответствующих прав доступа
chmod 644 ./certs/cert.pem ./certs/ca.pem
chmod 600 ./certs/key.pem
```

### Windows

```powershell
# Извлечение сертификатов (будет запрошен пароль)
Expand-Archive -Path "secure-certificates-v*.zip" -DestinationPath "./certs/"
```

### 7-Zip (для всех платформ)

Если архив был создан с помощью 7-Zip (наиболее защищенный вариант), используйте следующие команды:

```bash
# Linux/macOS
7z x secure-certificates-v*.zip -o./certs/

# Windows
7z x secure-certificates-v*.zip -o"./certs/"
```

## Устранение проблем

1. **Потерянный пароль**: Если пароль потерян, вам потребуется перегенерировать сертификаты
   - Запустите новую сборку релиза для генерации свежих сертификатов
   - Или вручную запустите скрипт генерации сертификатов на продакшн-сервере

2. **Проблемы с Telegram**: Если пароль не получен через Telegram
   - Проверьте логи GitHub Actions на наличие ошибок
   - Убедитесь, что токен бота и ID чата указаны корректно
   - Убедитесь, что бот имеет права на отправку сообщений в канал

3. **Проблемы с архивом**: При возникновении проблем с зашифрованным архивом
   - Попробуйте использовать другую программу для работы с ZIP, поддерживающую сильное шифрование
   - Для Linux: `unzip` с поддержкой шифрования или `p7zip`
   - Для Windows: встроенная поддержка ZIP или 7-Zip

4. **Различные методы шифрования**: В зависимости от доступных утилит на сервере CI, архив может быть создан разными способами
   - 7-Zip (AES-256): наиболее защищенный метод
   - Zip с паролем: стандартная зашита, доступная на большинстве систем
   - Простой архив с вложенным README: если не доступны другие методы (менее безопасно)

## Лучшие практики безопасности

- **Ротация токенов бота**: Периодически меняйте токен Telegram бота для повышения безопасности
- **Ограничение доступа к каналу**: Ограничьте доступ к каналу Telegram только авторизованным персоналом
- **Удаление паролей**: После использования удалите сообщение с паролем из Telegram
- **Безопасное хранение**: Храните извлеченные сертификаты в безопасном месте с соответствующими правами доступа
- **Сложные пароли**: Система использует криптографически стойкие пароли длиной 16 символов
- **Изолированный канал**: Используйте отдельный канал Telegram только для паролей от сертификатов
- **Шифрование ключей**: Обеспечьте дополнительное шифрование ключей на продакшен-серверах

## Дополнительные замечания

Эта система защиты сертификатов предназначена для обеспечения безопасности конфиденциальных файлов TLS-сертификатов во время их распространения. Она обеспечивает дополнительный уровень защиты помимо встроенной защиты артефактов GitHub, чтобы гарантировать, что сертификаты не могут быть скомпрометированы даже при раскрытии учетных данных GitHub.

### Технические детали

Система использует следующие компоненты:

1. **Скрипт защиты** (`scripts/secure-certificates.cjs`):
   - Генерирует криптографически стойкий случайный пароль
   - Автоматически определяет доступные инструменты шифрования (7-Zip, zip)
   - Создает защищенный архив с соответствующим уровнем шифрования
   - Отправляет пароль через Telegram API

2. **Поддерживаемые методы шифрования**:
   - 7-Zip с AES-256 (наиболее защищенный метод)
   - Стандартный zip с паролем
   - PowerShell Compress-Archive с вложенной информацией о пароле
   - Tar архив с вложенным паролем (крайний случай)

3. **Интеграция с GitHub Actions**:
   - Устанавливает необходимые инструменты (7-Zip или zip)
   - Запускает скрипт защиты во время сборки релиза
   - Загружает защищенный архив как артефакт
   - Включает архив в релиз

4. **Передача пароля**:
   - Осуществляется через шифрованное HTTPS соединение
   - Использует Telegram Bot API для безопасной доставки
   - Пароль никогда не сохраняется в репозитории или логах сборки
