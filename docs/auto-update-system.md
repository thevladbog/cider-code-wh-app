# Система автоматического обновления

В этой документации описана система автоматического обновления приложения Bottle CODE WH App.

## Общая архитектура

Система обновления основана на пакете `electron-updater` и позволяет автоматически проверять, загружать и устанавливать обновления из различных источников:

1. **GitHub Releases** (основной источник для публичных репозиториев)
2. **Локальный/частный сервер** (для закрытых сетей или индивидуальных установок)

## Настройка сервера обновлений

### Вариант 1: GitHub Releases (рекомендуется)

1. Создайте релиз в вашем репозитории GitHub
2. Загрузите исполняемые файлы (`.exe`, `.dmg`, `.AppImage`) в релиз
3. Убедитесь, что `forge.config.ts` содержит правильное имя репозитория и владельца

```typescript
publishers: [
  {
    name: '@electron-forge/publisher-github',
    config: {
      repository: {
        owner: 'your-username',
        name: 'bottle-code-wh-app'
      },
      draft: true,
      prerelease: packageData.version.includes('beta')
    }
  }
]
```

### Вариант 2: Локальный сервер обновлений

Для работы в закрытых сетях или в случае отсутствия доступа к GitHub можно настроить локальный сервер обновлений:

1. Запустите сервер обновлений:

```bash
npm run start:update-server
```

2. Сервер будет работать на порту 3001 (по умолчанию)
3. Разместите установочные файлы в директории `updates/`
4. Обновите `latest.json` информацией о новой версии

## Структура файлов системы обновлений

- `src/utils/updater.ts` - основная логика проверки и установки обновлений
- `src/utils/environment.ts` - утилиты определения окружения
- `src/components/UpdateManager.tsx` - React компонент для управления обновлениями
- `scripts/setup-update-server.cjs` - скрипт для запуска сервера обновлений
- `updates/latest.json` - информация о последней версии

## Процесс обновления

1. При запуске приложения автоматически проверяется наличие обновлений (в продакшн режиме)
2. Если обновление доступно, пользователю показывается уведомление
3. Пользователь может выбрать "Загрузить" для скачивания обновления
4. После загрузки пользователь может установить обновление сразу или отложить до следующего запуска

## Настройка периодичности проверки обновлений

По умолчанию приложение:
- Проверяет наличие обновлений при запуске (с задержкой 3 секунды)
- Проверяет наличие обновлений каждые 4 часа

Эти параметры можно изменить в файле `src/utils/updater.ts`.

## Подписывание обновлений

Для повышения безопасности рекомендуется подписывать обновления:

1. Создайте сертификат для подписи кода
2. Настройте переменные окружения:
   - `WINDOWS_CERTIFICATE_FILE` - путь к сертификату
   - `WINDOWS_CERTIFICATE_PASSWORD` - пароль сертификата
3. Обновления будут автоматически подписаны при сборке

## Интерфейс управления обновлениями

Для доступа к интерфейсу управления обновлениями перейдите на вкладку "Обновления" в главном окне приложения.
